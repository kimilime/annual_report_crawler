# 年报批量下载器 (Annual Report Crawler)

这是一个功能强大的Python脚本，由Terence Wang开发，旨在从多个数据源批量下载上市公司年报，以供后续进一步分析使用。

## 核心功能

- 🚀 **全市场支持**: 支持A股（主板、科创板、创业板）、港股、美股。
- 📊 **智能识别**: 自动根据股票代码格式识别市场及板块。
- 📥 **批量下载**: 支持通过交互式Web界面或命令行进行批量下载。
- 📅 **灵活年份**: 支持单年份、年份范围或不连续年份列表。
- 🌐 **Web界面**: 提供现代化、响应式的Web界面，操作直观，实时反馈进度。
- 📄 **格式统一**: 尽可能将下载的报告（包括HTML格式的美股10-K报告）转换为PDF。
- 📈 **详细报告**: 任务完成后提供详细的下载统计与失败原因分析。

## 部署与安装

#### 1. 基础环境

- **Python**: 3.7+
- **安装依赖包**:
  ```bash
  pip install -r requirements.txt
  ```

#### 2. 浏览器与驱动 (必需：用于科创板、创业板、港股)

这些市场的年报下载依赖于 [Selenium](https://www.selenium.dev/) 自动化浏览器操作。

- **浏览器**: 请确保您已安装 **Google Chrome** 浏览器。
- **驱动程序 (ChromeDriver)**:
    - **自动安装**: 脚本在首次运行时会尝试自动下载与您Chrome版本匹配的ChromeDriver。请优先尝试此方式。
    - **手动安装**: 如果自动下载失败（例如网络问题），请遵循以下步骤手动安装：
        1.  **查看Chrome版本**: 在浏览器地址栏输入 `chrome://version/` 并回车，记下您的版本号 (例如: `120.0.6099.109`)。
        2.  **下载驱动**: 访问 [ChromeDriver 官方镜像](https://googlechromelabs.github.io/chrome-for-testing/)，找到与您浏览器主版本号匹配的`chromedriver`，并下载对应操作系统的压缩包。
        3.  **配置路径**:
            - **Windows**: 解压 `chromedriver.exe` 到一个固定目录 (如 `C:\webdriver\`)，然后将此目录添加到系统的 `Path` 环境变量中。
            - **macOS / Linux**: 解压并将 `chromedriver` 文件移动到 `/usr/local/bin` 目录下，并确保它有执行权限 (`chmod +x /usr/local/bin/chromedriver`)。
        4.  **验证**: 打开新的终端窗口，输入 `chromedriver --version`，如果显示版本号则表示安装成功。

#### 3. PDF转换依赖 (必需：用于美股10-K报告)

为了将美股的HTML格式10-K报告转换为PDF，需要 `wkhtmltopdf` 工具。

- **Windows**:
  1.  访问 [wkhtmltopdf官网下载页面](https://wkhtmltopdf.org/downloads.html)。
  2.  下载并安装 `64-bit` 版本，安装程序会自动将其添加到系统路径。
- **macOS**:
  ```bash
  brew install wkhtmltopdf
  ```
- **Linux (Ubuntu/Debian)**:
  ```bash
  sudo apt-get install wkhtmltopdf
  ```

---

## 使用指南

### 方式一：Web界面 (推荐)

提供一个直观、实时、对新手友好的操作界面。

#### 启动步骤

1.  **启动服务**:
    - **Windows**: 直接双击运行 `start_web.bat` 批处理文件。
    - **macOS / Linux**: 在终端中运行 `./start_web.sh` 脚本。
    - **手动**: `python web_app_simple.py`
2.  **访问界面**:
    - 脚本启动后，会自动在默认浏览器中打开 `http://127.0.0.1:5000`。
    - 您也可以在局域网内的其他设备（如手机、平板）上通过 `http://[运行电脑的IP地址]:5000` 来访问。

#### 界面说明

1.  **数据源说明**:
    - **A股/港股**: 数据来自 **巨潮资讯网**。请注意，巨潮对港股的覆盖可能不完整，或有缺漏。
    - **美股**: 数据来自 **美国证券交易委员会 (SEC)** 披露的10-K文件。
2.  **下载配置**:
    - **股票代码**: 可每行输入一个，或用英文逗号分隔。
    - **年份**: 支持多种格式，如 `2023` 或 `2022,2023`。
    - **下载目录**: 指定报告存放的文件夹。
3.  **实时反馈**:
    - **进度条**: 实时显示总体下载进度。
    - **运行日志**: 滚动显示详细的执行日志，便于追踪。
    - **结果列表**: 实时展示已成功或失败的下载项。

### 方式二：命令行

适合需要自动化或集成到其他脚本中的高级用户。

#### 命令格式
```bash
python annual_report_downloader.py [-h] (-s STOCK | -f FILE) -y YEARS [-d DIR]
```

#### 参数详解

| 参数          | 描述                                     | 必需     | 示例                                     |
|---------------|------------------------------------------|----------|------------------------------------------|
| `-s, --stock` | 单个股票代码                               | 与`-f`互斥 | `-s 000001`                              |
| `-f, --file`  | 包含多个股票代码的文本文件路径（每行一个） | 与`-s`互斥 | `-f all_types_test_stocks.txt`           |
| `-y, --years` | 年份，支持单年、范围、列表                 | **是**   | `-y 2023` 或 `-y 2021-2023` 或 `-y 2021,2023` |
| `-d, --dir`   | 下载报告的存放目录（默认为`annual_reports`） | 否       | `-d ./my_reports`                        |

#### 使用示例

```bash
# 下载平安银行2023年年报
python annual_report_downloader.py -s 000001 -y 2023

# 下载宁德时代2021至2023的年报
python annual_report_downloader.py -s 300750 -y 2021-2023

# 批量下载文件中的所有股票的2023年报
python annual_report_downloader.py -f all_types_test_stocks.txt -y 2023
```

---

## 输出说明

#### 文件结构
默认情况下，下载的报告会按市场分类存放在 `annual_reports` 目录中：
```
annual_reports/
├── A股主板/
│   └── 000001_平安银行_2023年报.pdf
├── A股科创板/
│   └── 688111_金山办公_2023年报.pdf
├── 港股/
│   └── 00700_腾讯控股_2023年报.pdf
└── US/
    └── AAPL_2023_10K_2023-11-03.pdf
```

#### 汇总报告
所有任务结束后，控制台会输出一份详细的统计报告，包括成功/失败计数、成功率以及失败任务的详细列表。

---

## 技术实现与常见问题

- **A股主板**: 调用巨潮网公开API，直接获取PDF。
- **科创板/创业板/港股**: 通过Selenium模拟浏览器操作，在巨潮网进行搜索和下载。
- **美股**: 调用SEC EDGAR接口获取10-K报告的HTML原文，再使用 `wkhtmltopdf` 转换为PDF。
- **常见问题**:
  - **港股识别不准**: 脚本通过关键词过滤来识别正式年报，但仍可能因发布格式变动而出错。
  - **下载中断**: 请检查网络连接以及代理设置。
  - **ChromeDriver版本错误**: 请确保手动下载的驱动版本与您的Chrome浏览器版本严格对应。

## 项目结构

```
annual_report_crawler/
├── annual_report_downloader.py    # 主程序（命令行版本）
├── web_app.py                    # Web界面应用
├── start_web.bat                 # Windows Web启动脚本
├── start_web.sh                  # Linux/Mac Web启动脚本
├── templates/
│   └── index.html               # Web界面模板
├── requirements.txt             # Python依赖
├── all_types_test_stocks.txt    # 全类型股票测试文件
├── WEB_USAGE.md                 # Web界面使用指南
├── ChromeDriver_Setup_Guide.md  # Chrome驱动安装指南
├── tests_and_examples/          # 测试脚本和示例（被gitignore）
├── annual_reports/              # 默认下载目录（被gitignore）
└── README.md                    # 本文件
```

## 注意事项

1. **合规使用**: 本脚本仅用于学习和研究目的，请遵守相关网站的使用条款
2. **频率控制**: 脚本内置了请求间隔，请勿修改以免被网站封禁
3. **数据准确性**: 下载的文件请以官方发布为准
4. **环境要求**: 确保Python环境和依赖包版本兼容
5. **PDF依赖**: 必须正确安装wkhtmltopdf才能生成PDF文件
6. **美股限制**: SEC网站可能有访问限制，建议合理控制请求频率

## 更新日志

### v2.1.1
- 🐛 修复Web界面中文编码问题
- 📝 更新版权年份到2025
- 🔧 增强文件读取的编码兼容性

### v2.1.0
- ✨ 新增Web界面功能！支持浏览器操作
- 🌐 提供用户友好的Web界面，无需命令行知识
- 📊 实时进度显示和运行日志
- 📥 Web界面一键下载文件功能
- 📱 响应式设计，支持手机和平板访问
- 🚀 简化使用流程：启动服务器 → 打开浏览器 → 开始下载

### v2.0.1
- 🐛 修复港股年报识别误判问题
- 📝 增强港股年报过滤逻辑，排除通知信函等非年报文档
- ✅ 确保港股下载的是真正的年度报告

### v2.0.0
- ✨ 新增美股10-K报告下载功能
- ✨ 支持真正的PDF格式输出
- ✨ 添加wkhtmltopdf和weasyprint PDF转换支持
- 🐛 修复返回值格式不统一的问题
- 📝 更新README和项目结构
- 🗂️ 整理测试文件到独立目录

### v1.0.0
- 初始版本发布
- 支持A股主板、科创板、创业板和港股
- 实现批量下载和进度显示
- 添加详细的错误处理和汇总报告
