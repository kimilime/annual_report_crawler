# 年报批量下载器 (Annual Report Crawler)

这是一个功能强大的Python脚本，由Terence Wang开发，旨在从多个数据源批量下载上市公司年报，以供后续进一步分析使用。

## 🔥 版本选择

### 🌐 浏览器下载版本（推荐！）
**适用场景**: 公司电脑、企业环境、安全软件环境
- ✅ **避免文件加密**: 通过浏览器下载，绕过企业安全软件的文件加密
- ✅ **企业兼容**: 兼容绿盾、域之盾等企业安全软件  
- ✅ **完整功能**: 保留所有原有功能，支持全市场下载
- ✅ **可视化下载**: 可以看到浏览器下载过程，更加透明

**使用方式**: 
- 双击运行 `start_web_bd.bat`
- 浏览器访问 http://localhost:5000

### 📊 标准版本
**适用场景**: 个人电脑、无安全软件限制的环境
- ✅ **经典稳定**: 原有的requests下载方式
- ✅ **高效快速**: 下载速度更快
- ✅ **命令行友好**: 适合自动化脚本

**使用方式**:
- 双击运行 `start_web_rq.bat` 
- 或命令行 `python annual_report_downloader_rq.py`

## 核心功能

- 🚀 **全市场支持**: 支持A股（主板、科创板、创业板）、港股、美股。
- 📊 **智能识别**: 自动根据股票代码格式识别市场及板块。
- 📥 **批量下载**: 支持通过交互式Web界面或命令行进行批量下载。
- 📅 **灵活年份**: 支持单年份、年份范围或不连续年份列表。
- 🌐 **Web界面**: 提供现代化、响应式的Web界面，操作直观，实时反馈进度。
- 📄 **多格式支持**: A股和港股下载为PDF格式，美股下载为HTML格式的10-K报告。
- 📈 **详细报告**: 任务完成后提供详细的下载统计与失败原因分析。
- 🔒 **企业友好**: 浏览器下载版本完美适配企业安全环境。

## 部署与安装

#### 1. 基础环境

- **Python**: 3.7+
- **自动安装依赖**: 启动脚本会自动检测并安装所需依赖包

#### 2. 浏览器与驱动 (必需：用于科创板、创业板、港股)

这些市场的年报下载依赖于 [Selenium](https://www.selenium.dev/) 自动化浏览器操作。

- **浏览器**: 请确保您已安装 **Google Chrome** 浏览器。
- **驱动程序 (ChromeDriver)**:
    - **自动安装**: 脚本在首次运行时会尝试自动下载与您Chrome版本匹配的ChromeDriver。请优先尝试此方式。
    - **手动安装**: 如果自动下载失败（例如网络问题），请遵循以下步骤手动安装：
        1.  **查看Chrome版本**: 在浏览器地址栏输入 `chrome://version/` 并回车，记下您的版本号 (例如: `120.0.6099.109`)。
        2.  **下载驱动**: 访问 [ChromeDriver 官方镜像](https://googlechromelabs.github.io/chrome-for-testing/)，找到与您浏览器主版本号匹配的`chromedriver`，并下载对应操作系统的压缩包。
        3.  **配置路径**:
            - **Windows**: 解压 `chromedriver.exe` 到一个固定目录 (如 `C:\webdriver\`)，然后将此目录添加到系统的 `Path` 环境变量中。
            - **macOS / Linux**: 解压并将 `chromedriver` 文件移动到 `/usr/local/bin` 目录下，并确保它有执行权限 (`chmod +x /usr/local/bin/chromedriver`)。
        4.  **验证**: 打开新的终端窗口，输入 `chromedriver --version`，如果显示版本号则表示安装成功。

#### 3. 文件格式说明

- **A股和港股**: 下载为PDF格式，无需额外工具。
- **美股**: 直接保存为HTML格式的10-K报告，无需PDF转换工具。

---

## 使用指南

### 🌐 方式一：浏览器下载版本Web界面 (推荐)

**特别适合**: 公司电脑、有安全软件的环境，文件下载会被加密的情况。

#### 启动步骤

1.  **启动服务**:
    - **Windows**: 直接双击运行 `start_web_bd.bat` 批处理文件。
    - **手动**: `python web_app_bd.py`
2.  **访问界面**:
    - 脚本启动后，会自动在浏览器中打开 `http://localhost:5000`。
    - 您也可以在局域网内的其他设备上通过 `http://[运行电脑的IP地址]:5000` 来访问。

#### 特色说明
- 🔒 **绕过文件加密**: 所有文件通过浏览器下载，避免被企业安全软件加密
- 👀 **可视化过程**: 可以看到Chrome浏览器的下载过程（默认无头模式，可配置显示）
- ⚡ **实时反馈**: Web界面实时显示下载进度和日志
- 📁 **智能管理**: 自动检测下载完成，智能重命名文件

### 📊 方式二：标准版本Web界面

提供一个直观、实时、对新手友好的操作界面。

#### 启动步骤

1.  **启动服务**:
    - **Windows**: 直接双击运行 `start_web_rq.bat` 批处理文件。
    - **手动**: `python web_app_rq.py`
2.  **访问界面**:
    - 脚本启动后，会自动在默认浏览器中打开 `http://localhost:5000`。
    - 您也可以在局域网内的其他设备（如手机、平板）上通过 `http://[运行电脑的IP地址]:5000` 来访问。

#### 界面说明

1.  **数据源说明**:
    - **A股/港股**: 数据来自 **巨潮资讯网**，下载格式为PDF。请注意，巨潮对港股的覆盖可能不完整，或有缺漏。
    - **美股**: 数据来自 **美国证券交易委员会 (SEC)** 披露的10-K文件，下载格式为HTML。
2.  **下载配置**:
    - **股票代码**: 可每行输入一个，或用英文逗号分隔。
    - **年份**: 支持多种格式，如 `2024` 或 `2023,2024`。
    - **下载目录**: 指定报告存放的文件夹。
3.  **实时反馈**:
    - **进度条**: 实时显示总体下载进度。
    - **运行日志**: 滚动显示详细的执行日志，便于追踪。
    - **结果列表**: 实时展示已成功或失败的下载项。

### 方式三：命令行

适合需要自动化或集成到其他脚本中的高级用户。

#### 命令格式
```bash
python annual_report_downloader_rq.py [-h] (-s STOCK | -f FILE) -y YEARS [-d DIR]
```

#### 参数详解

| 参数          | 描述                                     | 必需     | 示例                                     |
|---------------|------------------------------------------|----------|------------------------------------------|
| `-s, --stock` | 单个股票代码                               | 与`-f`互斥 | `-s 000001`                              |
| `-f, --file`  | 包含多个股票代码的文本文件路径（每行一个） | 与`-f`互斥 | `-f all_types_test_stocks.txt`           |
| `-y, --years` | 年份，支持单年、范围、列表                 | **是**   | `-y 2024` 或 `-y 2022-2024` 或 `-y 2022,2024` |
| `-d, --dir`   | 下载报告的存放目录（默认为`annual_reports`） | 否       | `-d ./my_reports`                        |

#### 使用示例

```bash
# 下载平安银行2024年年报
python annual_report_downloader_rq.py -s 000001 -y 2024

# 下载宁德时代2022至2024的年报
python annual_report_downloader_rq.py -s 300750 -y 2022-2024

# 批量下载文件中的所有股票的2024年报
python annual_report_downloader_rq.py -f all_types_test_stocks.txt -y 2024
```

---

## 输出说明

#### 文件结构
默认情况下，下载的报告会按市场分类存放在 `annual_reports` 目录中：
```
annual_reports/
├── A股主板/
│   └── 000001_平安银行_2024年报.pdf
├── A股科创板/
│   └── 688111_金山办公_2024年报.pdf
├── 港股/
│   └── 00700_腾讯控股_2024年报.pdf
└── US/
    └── AAPL_2024_10K_2024-11-03.html
```

#### 汇总报告
所有任务结束后，控制台会输出一份详细的统计报告，包括成功/失败计数、成功率以及失败任务的详细列表。

---

## 技术实现与常见问题

- **A股主板**: 调用巨潮网公开API，直接获取PDF。
- **科创板/创业板/港股**: 通过Selenium模拟浏览器操作，在巨潮网进行搜索和下载PDF。
- **美股**: 调用SEC EDGAR接口获取10-K报告的HTML原文，直接保存为HTML格式。
- **常见问题**:
  - **港股识别不准**: 脚本通过关键词过滤来识别正式年报，但仍可能因发布格式变动而出错。
  - **下载中断**: 请检查网络连接以及代理设置。
  - **ChromeDriver版本错误**: 请确保手动下载的驱动版本与您的Chrome浏览器版本严格对应。

## 项目结构

```
annual_report_crawler/
├── 🌐 浏览器下载版本
│   ├── annual_report_downloader_bd.py  # 浏览器下载版本主程序
│   ├── web_app_bd.py                  # 浏览器下载版本Web应用
│   ├── start_web_bd.bat               # 浏览器版本启动脚本
│   └── test_browser_download.py       # 浏览器版本测试脚本
├── 📊 标准版本
│   ├── annual_report_downloader_rq.py # 标准版本主程序（命令行版本）
│   ├── web_app_rq.py                 # 标准版本Web界面应用
│   ├── start_web_rq.bat              # 标准版本启动脚本
│   └── all_types_test_stocks.txt     # 测试股票代码文件
├── templates/
│   ├── index.html                    # 标准版本Web界面模板
│   └── index_bd.html                 # 浏览器下载版本Web界面模板
└── README.html                       # 项目文档（Web版）
```

---

## 版本对比

| 特性 | 标准版本 | 浏览器下载版本 |
|------|---------|---------------|
| **下载方式** | HTTP requests | 浏览器下载 |
| **速度** | 快速 | 相对较慢 |
| **文件加密问题** | 可能被加密 | ✅ 避免加密 |
| **企业安全软件兼容** | 可能冲突 | ✅ 完全兼容 |
| **可视化** | 无 | ✅ 可见下载过程 |
| **资源占用** | 低 | 相对较高 |
| **适用场景** | 个人电脑 | 企业环境 |

---

## 许可证

本项目基于 MIT 许可证开源。详见 [LICENSE](LICENSE) 文件。

---

## 作者

**Terence WANG**

如有问题或建议，欢迎通过 GitHub Issues 联系。
